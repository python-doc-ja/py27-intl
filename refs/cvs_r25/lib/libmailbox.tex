\section{\module{mailbox} ---
         様々な形式のメールボックス操作}

\declaremodule{}{mailbox}
\moduleauthor{Gregory K.~Johnson}{gkj@gregorykjohnson.com}
\sectionauthor{Gregory K.~Johnson}{gkj@gregorykjohnson.com}
\modulesynopsis{様々な形式のメールボックス操作}


このモジュールでは二つのクラス \class{Mailbox} および \class{Message} を
ディスク上のメールボックスとそこに収められたメッセージへのアクセスと操作のために
定義しています。\class{Mailbox} は辞書のようなキーからメッセージへの対応付けを
提供しています。\class{Message} は \module{email.Message} モジュールの
\class{Message} を拡張して形式ごとの状態と振る舞いを追加しています。
サポートされるメールボックスの形式は Maildir, mbox, MH, Babyl, MMDF です。

\begin{seealso}
    \seemodule{email}{メッセージの表現と操作}
\end{seealso}

\subsection{\class{Mailbox} オブジェクト}
\label{mailbox-objects}

\begin{classdesc*}{Mailbox}
メールボックス。中を見られたり変更されたりします。
\end{classdesc*}

\class{Mailbox} のインタフェースは辞書風で、小さなキーがメッセージに対応します。
キーは対象となる \class{Mailbox} インスタンスが発行するもので、そのインスタンスに対して
のみ意味を持ちます。一つのキーは一つのメッセージにひも付けられ、その対応はメッセージが
他のメッセージで置き換えられるような更新をされたあとも続きます。メッセージを
\class{Mailbox} インスタンスに追加するには集合風のメソッド \method{add()} を使います。
また削除は \code{del} 文または集合風の \method{remove()} や \method{discard()}
を使って行ないます。

\class{Mailbox} インタフェースのセマンティクスと辞書のそれとは注意すべき違いが
あります。メッセージは、要求されるたびに新しい表現(典型的には \class{Message}
インスタンス)が現在のメールボックスの状態に基づいて生成されます。同様に、メッセージが
\class{Mailbox} インスタンスに追加される時も、渡されたメッセージ表現の内容が
コピーされます。どちらの場合も \class{Makebox} インスタンスにメッセージ表現
への参照は保たれません。

デフォルトの \class{Mailbox} イテレータはメッセージ表現ごとに繰り返すもので、
辞書のイテレータのようにキーごとの繰り返しではありません。さらに、繰り返し中の
メールボックスを変更することは安全であり整合的に定義されています。イテレータが
作られた後にメールボックスに追加されたメッセージはそのイテレータからは見えません。
そのイテレータが yield するまえにメールボックスから削除されたメッセージは
黙ってスキップされますが、イテレータからのキーを使ったときにはそのキーに対応する
メッセージが削除されているならば \exception{KeyError} を受け取ることに
なります。

\class{Mailbox} 自体はインタフェースを定義し形式ごとのサブクラスに継承される
ように意図されたもので、インスタンス化されることは想定されていません。インスタンス化
したいならばサブクラスを代わりに使うべきです。

\class{Mailbox} インスタンスには次のメソッドがあります。

\begin{methoddesc}{add}{message}
メールボックスに \var{message} を追加し、それに割り当てられたキーを返します。

引数 \var{message} は \class{Message} インスタンス、
\class{email.Message.Message} インスタンス、文字列、ファイル風オブジェクト
(テキストモードで開かれていなければなりませんが)を使えます。
\var{message} が適切な形式に特化した \class{Message} サブクラスのインスタンス
(例えばメールボックスが \class{mbox} インスタンスのときの \class{mboxMessage} 
インスタンス)であれば、形式ごとの情報が利用されます。そうでなければ、形式ごとに
必要な情報は適当なデフォルトが使われます。
\end{methoddesc}

\begin{methoddesc}{remove}{key}
\methodline{__delitem__}{key}
\methodline{discard}{key}
メールボックスから \var{key} に対応するメッセージを削除します。

対応するメッセージが無い場合、メソッドが \method{remove()} または
\method{__delitem__()} として呼び出されている時は \exception{KeyError} 例外が
送出されます。しかし、\method{discard()} として呼び出されている場合は例外は発生
しません。基づいているメールボックス形式が別のプロセスからの平行した変更をサポート
しているならば、この \method{discard()} の振る舞いの方が好まれるかもしれません。
\end{methoddesc}

\begin{methoddesc}{__setitem__}{key, message}
\var{key} に対応するメッセージを \var{message} で置き換えます。
\var{key} に対応しているメッセージが既に無くなっている場合 \exception{KeyError} 例外
が送出されます。

\method{add()} と同様に、引数の \var{message} には \class{Message} イン
スタンス、\class{email.Message.Message} インスタンス、文字列、ファイル
風オブジェクト(テキストモードで開かれていなければなりませんが)を使えま
す。\var{message} が適切な形式に特化した \class{Message} サブクラスのイ
ンスタンス(例えばメールボックスが \class{mbox} インスタンスのとき
の \class{mboxMessage} インスタンス)であれば、形式ごとの情報が利用され
ます。そうでなければ、現在 \var{key} に対応するメッセージの形式ごとの情報が
変更されずに残ります。
\end{methoddesc}

\begin{methoddesc}{iterkeys}{}
\methodline{keys}{}
\method{iterkeys()} として呼び出されると全てのキーについてのイテレータを返しますが、
\method{keys()} として呼び出されるとキーのリストを返します。
\end{methoddesc}

\begin{methoddesc}{itervalues}{}
\methodline{__iter__}{}
\methodline{values}{}
\method{itervalues()} または \method{__iter__()} として呼び出されると
全てのメッセージの表現についてのイテレータを返しますが、
\method{values()} として呼び出されるとその表現のリストを返します。
メッセージは適切な形式ごとの \class{Message} サブクラスのインスタンスとして表現される
のが普通ですが、\class{Mailbox} インスタンスが初期化されるときに指定すればお好みの
メッセージファクトリを使うこともできます。\note{\method{__iter__()} は
辞書のそれのようにキーについてのイテレータではありません。}
\end{methoddesc}

\begin{methoddesc}{iteritems}{}
\methodline{items}{}
(\var{key}, \var{message}) ペア、ただし \var{key} はキーで \var{message} は
メッセージ表現、のイテレータ(\method{iteritems()} として呼び出された場合)、または
リスト(\method{items()} として呼び出された場合)を返します。メッセージは適切な
形式ごとの \class{Message} サブクラスのインスタンスとして表現される
のが普通ですが、\class{Mailbox} インスタンスが初期化されるときに指定すればお好みの
メッセージファクトリを使うこともできます。
\end{methoddesc}

\begin{methoddesc}{get}{key\optional{, default=None}}
\methodline{__getitem__}{key}
\var{key} に対応するメッセージの表現を返します。
対応するメッセージが存在しない場合、\method{get()} として呼び出されたなら \var{default}
を返しますが、\method{__getitem__()} として呼び出されたなら \exception{KeyError} 例外
が送出されます。メッセージは適切な
形式ごとの \class{Message} サブクラスのインスタンスとして表現される
のが普通ですが、\class{Mailbox} インスタンスが初期化されるときに指定すればお好みの
メッセージファクトリを使うこともできます。
\end{methoddesc}

\begin{methoddesc}{get_message}{key}
\var{key} に対応するメッセージの表現を形式ごとの \class{Message} サブクラスの
インスタンスとして返します。もし対応するメッセージが存在しなければ
\exception{KeyError} 例外が送出されます。
\end{methoddesc}

\begin{methoddesc}{get_string}{key}
\var{key} に対応するメッセージの表現を文字列として返します。もし対応するメッセージが
存在しなければ\exception{KeyError} 例外が送出されます。
\end{methoddesc}

\begin{methoddesc}{get_file}{key}
\var{key} に対応するメッセージの表現をファイル風表現として返します。
もし対応するメッセージが存在しなければ\exception{KeyError} 例外が送出
されます。ファイル風オブジェクトはバイナリモードで開かれているように
振る舞います。このファイルは必要がなくなったら閉じなければなりません。

\note{他の表現方法とは違い、ファイル風オブジェクトはそれを作り出した \class{Mailbox} 
インスタンスやそれが基づいているメールボックスと独立である必要がありません。
より詳細な説明は各サブクラスごとにあります。}
\end{methoddesc}

\begin{methoddesc}{has_key}{key}
\methodline{__contains__}{key}
\var{key} がメッセージに対応していれば \code{True} を、そうでなければ \code{False}
を返します。
\end{methoddesc}

\begin{methoddesc}{__len__}{}
メールボックス中のメッセージ数を返します。
\end{methoddesc}

\begin{methoddesc}{clear}{}
メールボックスから全てのメッセージを削除します。
\end{methoddesc}

\begin{methoddesc}{pop}{key\optional{, default}}
\var{key} に対応するメッセージの表現を返します。もし対応するメッセージが存在しなければ
\var{default} が供給されていればその値を返し、そうでなければ \exception{KeyError}
例外を送出します。メッセージは適切な
形式ごとの \class{Message} サブクラスのインスタンスとして表現される
のが普通ですが、\class{Mailbox} インスタンスが初期化されるときに指定すればお好みの
メッセージファクトリを使うこともできます。
\end{methoddesc}

\begin{methoddesc}{popitem}{}
任意に選んだ (\var{key}, \var{message}) ペアを返します。
ただしここで \var{key} はキーで \var{message} はメッセージ表現です。
もしメールボックスが空ならば、\exception{KeyError}
例外を送出します。メッセージは適切な
形式ごとの \class{Message} サブクラスのインスタンスとして表現される
のが普通ですが、\class{Mailbox} インスタンスが初期化されるときに指定すればお好みの
メッセージファクトリを使うこともできます。
\end{methoddesc}

\begin{methoddesc}{update}{arg}
引数 \var{arg} は \var{key} から \var{message} へのマッピングまたは
(\var{key}, \var{message}) ペアのイテレート可能オブジェクトでなければなりません。
メールボックスは、各 \var{key} と \var{message} のペアについて
\method{__setitem__()} を使ったかのように
\var{key} に対応するメッセージが \var{message} になるように更新されます。
\method{__setitem__()} と同様に、\var{key} は既存のメールボックス中のメッセージ
に対応しているものでなければならず、そうでなければ \exception{KeyError} が送出されます。
ですから、一般的には \var{arg} に \class{Mailbox} インスタンスを渡すのは間違いです。
\note{辞書と違い、キーワオード引数はサポートされていません。}
\end{methoddesc}

\begin{methoddesc}{flush}{}
保留されている変更をファイルシステムに書き込みます。\class{Mailbox} のサブクラス
によっては変更はいつも直ちにファイルに書き込まれこのメソッドは何もしないという
こともあります。
\end{methoddesc}

\begin{methoddesc}{lock}{}
メールボックスの排他的アドバイザリロックを取得し、他のプロセスが変更しないようにします。
ロックが取得できない場合 \exception{ExternalClashError} が送出されます。
ロック機構はメールボックス形式によって変わります。
\end{methoddesc}

\begin{methoddesc}{unlock}{}
メールボックスのロックを、もしあれば、解放します。
\end{methoddesc}

\begin{methoddesc}{close}{}
+Flush the mailbox, unlock it if necessary, and close any open files. For some
+\class{Mailbox} subclasses, this method does nothing.
メールボックスをフラッシュし、必要ならばアンロックし、開いているファイルを閉じます。
\class{Mailbox} サブクラスによっては何もしないこともあります。
\end{methoddesc}


\subsubsection{\class{Maildir}}
\label{mailbox-maildir}

\begin{classdesc}{Maildir}{dirname\optional{, factory=rfc822.Message\optional{,
create=True}}}
Maildir 形式のメールボックスのための \class{Mailbox} のサブクラス。
パラメータ \var{factory} は呼び出し可能オブジェクトで
(バイナリモードで開かれているかのように振る舞う)ファイル風メッセージ表現を
受け付けて好みの表現を返すものです。\var{factory} が \code{None}ならば、
\class{MaildirMessage} がデフォルトのメッセージ表現として使われます。
\var{create} が \code{True} ならばメールボックスが存在しないときには
作成します。

\var{factory} のデフォルトが \class{rfc822.Message} であったり、
\var{path} ではなく \var{dirname} という名前であったりというのは
歴史的理由によるものです。\class{Maildir} インスタンスが他の \class{Mailbox} 
サブクラスと同じように振る舞わせるためには、\var{factory} に \code{None} を
セットしてください。
\end{classdesc}

Maildir はディレクトリ型のメールボックス形式でメール転送エージェント qmail 用に
発明され、現在では多くの他のプログラムでもサポートされているものです。Maildir
メールボックス中のメッセージは共通のディレクトリ構造の下で個別のファイルに保存されます。
このデザインにより、Maildir メールボックスは複数の無関係の
プログラムからデータを失うことなくアクセスしたり変更したりできます。
そのためロックは不要です。

Maildir メールボックスには三つのサブディレクトリ \file{tmp}, \file{new},
\file{cur} があります。メッセージはまず \file{tmp} サブディレクトリに瞬間的に
作られた後、\file{new} サブディレクトリに移動されて配送を完了します。メールユーザ
エージェントが引き続いて \file{cur} サブディレクトリにメッセージを移動し
メッセージの状態についての情報をファイル名に追加される特別な"info"セクションに
保存することができます。

Courier メール転送エージェントによって導入されたスタイルのフォルダもサポートされます。
主たるメールボックスのサブディレクトリは \character{.} がファイル名の先頭であれば
フォルダと見なされます。フォルダ名は \class{Maildir} によって先頭の \character{.}
を除いて表現されます。各フォルダはまた Maildir メールボックスですがさらにフォルダを
含むことはできません。その代わり、論理的包含関係は例えば "Archived.2005.07" のような
\character{.} を使ったレベル分けで表わされます。

\begin{notice}
本来の Maildir 仕様ではある種のメッセージのファイル名にコロン(\character{:})を
使う必要があります。しかしながら、オペレーティングシステムによってはこの文字を
ファイル名に含めることができないことがあります。そういった環境で Maildir のような
形式を使いたい場合、代わりに使われる文字を指定する必要があります。感嘆符(\character{!})
を使うのが一般的な選択です。以下の例を見てください。
\begin{verbatim}
import mailbox
mailbox.Maildir.colon = '!'
\end{verbatim}
\member{colon} 属性はインスタンスごとにセットしても構いません。
\end{notice}

\class{Maildir} インスタンスには \class{Mailbox} の全てのメソッドに加え以下の
メソッドもあります。

\begin{methoddesc}{list_folders}{}
全てのフォルダ名のリストを返します。
\end{methoddesc}

\begin{methoddesc}{get_folder}{folder}
名前が \var{folder} であるフォルダを表わす \class{Maildir} インスタンスを返します。
そのようなフォルダが存在しなければ \exception{NoSuchMailboxError} 例外が送出されます。
\end{methoddesc}

\begin{methoddesc}{add_folder}{folder}
名前が \var{folder} であるフォルダを作り、それを表わす \class{Maildir}
インスタンスを返します。
\end{methoddesc}

\begin{methoddesc}{remove_folder}{folder}
名前が \var{folder} であるフォルダを削除します。もしフォルダに一つでもメッセージが
含まれていれば \exception{NotEmptyError} 例外が送出されフォルダは削除されません。
\end{methoddesc}

\begin{methoddesc}{clean}{}
過去36時間以内にアクセスされなかったメールボックス内の一時ファイルを削除します。
Maildir 仕様はメールを読むプログラムはときどきこの作業をすべきだとしています。
\end{methoddesc}

\class{Maildir} で実装された \class{Mailbox} のいくつかのメソッドには特別な注意が
必要です。

\begin{methoddesc}{add}{message}
\methodline[Maildir]{__setitem__}{key, message}
\methodline[Maildir]{update}{arg}
\warning{これらのメソッドは一意的なファイル名をプロセスIDに基づいて生成します。
複数のスレッドを使う場合は、同じメールボックスを同時に操作しないようにスレッド間で
調整しておかないと検知されない名前の衝突が起こりメールボックスを壊すかもしれません。}
\end{methoddesc}

\begin{methoddesc}{flush}{}
Maildir メールボックスへの変更は即時に適用されるので、このメソッドは何もしません。
\end{methoddesc}

\begin{methoddesc}{lock}{}
\methodline{unlock}{}
Maildir メールボックスはロックをサポート(または要求)しないので、
このメソッドは何もしません。
\end{methoddesc}

\begin{methoddesc}{close}{}
\class{Maildir} インスタンスは開いたファイルを保持しませんしメールボックスは
ロックをサポートしませんので、このメソッドは何もしません。
\end{methoddesc}

\begin{methoddesc}{get_file}{key}
ホストのプラットフォームによっては、返されたファイルが開いている間元になったメッセージを
変更したり削除したりできない場合があります。
\end{methoddesc}

\begin{seealso}
    \seelink{http://www.qmail.org/man/man5/maildir.html}{qmail の maildir man 
      ページ}{Maildir 形式のオリジナルの仕様}
    \seelink{http://cr.yp.to/proto/maildir.html}{Using maildir format}{
      Maildir 形式の発明者による注意書き。更新された名前生成規則と "info" の解釈
      についても含まれます。}
    \seelink{http://www.courier-mta.org/?maildir.html}{Courier の maildir man
      ページ}{Maildir 形式のもう一つの仕様。フォルダをサポートする一般的な拡張について
      記述されています。}
\end{seealso}

\subsubsection{\class{mbox}}
\label{mailbox-mbox}

\begin{classdesc}{mbox}{path\optional{, factory=None\optional{, create=True}}}
mbox 形式のメールボックスのための \class{Mailbox} のサブクラス。
パラメータ \var{factory} は呼び出し可能オブジェクトで
(バイナリモードで開かれているかのように振る舞う)ファイル風メッセージ表現を
受け付けて好みの表現を返すものです。\var{factory} が \code{None}ならば、
\class{mboxMessage} がデフォルトのメッセージ表現として使われます。
\var{create} が \code{True} ならばメールボックスが存在しないときには
作成します。
\end{classdesc}

mbox 形式は \UNIX システム上でメールを保存する古くからある形式です。
mbox メールボックスでは全てのメッセージが一つのファイルに保存されており
それぞれのメッセージは "From~" という5文字で始まる行を先頭に付けられています。

mbox 形式には幾つかのバリエーションがあり、それぞれオリジナルの形式にあった欠点を克服すると
主張しています。互換性のために、\class{mbox} はオリジナルの(時に \dfn{mboxo} と呼ばれる)
形式を実装しています。すなわち、\mailheader{Content-Length} ヘッダはもしあっても
無視され、メッセージのボディにある行頭の "From~" はメッセージを保存する際に
">From~" に変換されますが、この ">From~" は読み出し時にも "From~" に変換されません。

\class{mbox} で実装された \class{Mailbox} のいくつかのメソッドには特別な注意が
必要です。

\begin{methoddesc}{get_file}{key}
\class{mbox} インスタンスに対し \method{flush()} や \method{close()} を呼び出した
後でファイルを使用すると予期しない結果を引き起こしたり例外が送出されたりすることがあります。
\end{methoddesc}

\begin{methoddesc}{lock}{}
\methodline{unlock}{}
3種類のロック機構が使われます --- ドットロッキングと、もし使用可能ならば
\cfunction{flock()} と \cfunction{lockf()} システムコールです。
\end{methoddesc}

\begin{seealso}
    \seelink{http://www.qmail.org/man/man5/mbox.html}{qmail の mbox man
      ページ}{mbox 形式の仕様および種々のバリエーション}
    \seelink{http://www.tin.org/bin/man.cgi?section=5\&topic=mbox}{tin の
      mbox man ページ}{もう一つの mbox 形式の仕様でロックについての詳細を含む}
    \seelink{http://home.netscape.com/eng/mozilla/2.0/relnotes/demo/content-length.html}
    {Configuring Netscape Mail on \UNIX{}: Why The Content-Length Format is
      Bad}{バリエーションの一つではなくオリジナルの mbox を使う理由}
    \seelink{http://homepages.tesco.net./\tilde{}J.deBoynePollard/FGA/mail-mbox-formats.html}
    {"mbox" is a family of several mutually incompatible mailbox formats}{
      mbox バリエーションの歴史}
\end{seealso}

\subsubsection{\class{MH}}
\label{mailbox-mh}

\begin{classdesc}{MH}{path\optional{, factory=None\optional{, create=True}}}
MH 形式のメールボックスのための \class{Mailbox} のサブクラス。
パラメータ \var{factory} は呼び出し可能オブジェクトで
(バイナリモードで開かれているかのように振る舞う)ファイル風メッセージ表現を
受け付けて好みの表現を返すものです。\var{factory} が \code{None}ならば、
\class{MHMessage} がデフォルトのメッセージ表現として使われます。
\var{create} が \code{True} ならばメールボックスが存在しないときには
作成します。
\end{classdesc}

MH はディレクトリに基づいたメールボックス形式で MH Message Handling System 
というメールユーザエージェントのために発明されました。MH メールボックス中の
それぞれのメッセージは一つのファイルとして収められています。MH メールボックスには
メッセージの他に別の MH メールボックス(\dfn{フォルダ} と呼ばれます)を含んでも
かまいません。フォルダは無限にネストできます。MH メールボックスにはもう一つ
\dfn{シーケンス} という名前付きのリストでメッセージをサブフォルダに移動することなく
論理的に分類するものがサポートされています。シーケンスは各フォルダの
\file{.mh_sequences} というファイルで定義されます。

\class{MH} クラスは MH メールボックスを操作しますが、\program{mh} の動作の全てを
模倣しようとはしていません。特に、\program{mh} が状態と設定を保存する
\file{context} や \file{.mh_profile} といったファイルは書き換えませんし
影響も受けません。

\class{MH} インスタンスには \class{Mailbox} の全てのメソッドの他に次のメソッドが
あります。

\begin{methoddesc}{list_folders}{}
全てのフォルダの名前のリストを返します。
\end{methoddesc}

\begin{methoddesc}{get_folder}{folder}
\var{folder} という名前のフォルダを表わす \class{MH} インスタンスを返します。
もしフォルダが存在しなければ \exception{NoSuchMailboxError} 例外が送出されます。
\end{methoddesc}

\begin{methoddesc}{add_folder}{folder}
\var{folder} という名前のフォルダを作成し、それを表わす \class{MH} インスタンスを
返します。
\end{methoddesc}

\begin{methoddesc}{remove_folder}{folder}
\var{folder} という名前のフォルダを削除します。フォルダにメッセージが一つでも残っていれば、
\exception{NotEmptyError} 例外が送出されフォルダは削除されません。
\end{methoddesc}

\begin{methoddesc}{get_sequences}{}
シーケンス名をキーのリストに対応付ける辞書を返します。シーケンスが一つもなければ
空の辞書を返します。
\end{methoddesc}

\begin{methoddesc}{set_sequences}{sequences}
メールボックス中のシーケンスを \method{get_sequences()} で返されるような名前と
キーのリストを対応付ける辞書 \var{sequences} に基づいて再定義します。
\end{methoddesc}

\begin{methoddesc}{pack}{}
番号付けの間隔を詰める必要に応じてメールボックス中のメッセージの名前を付け替えます。
シーケンスのリストのエントリもそれに応じて更新されます。\note{既に発行された
キーはこの操作によって無効になるのでそれ以降使ってはなりません。}
\end{methoddesc}

\class{MH} で実装された \class{Mailbox} のいくつかのメソッドには特別な注意が
必要です。

\begin{methoddesc}{remove}{key}
\methodline{__delitem__}{key}
\methodline{discard}{key}
これらのメソッドはメッセージを直ちに削除します。名前の前にコンマを付加して
メッセージに削除の印を付けるという MH の規約は使いません。
\end{methoddesc}

\begin{methoddesc}{lock}{}
\methodline{unlock}{}
3種類のロック機構が使われます --- ドットロッキングと、もし使用可能ならば
\cfunction{flock()} と \cfunction{lockf()} システムコールです。
MH メールボックスに対するロックとは \file{.mh_sequences} のロックと、
それが影響を与える操作中だけの個々のメッセージファイルに対するロックを意味します。
\end{methoddesc}

\begin{methoddesc}{get_file}{key}
ホストのプラットフォームによっては、返されたファイルが開いている間元になったメッセージを
変更したり削除したりできない場合があります。
\end{methoddesc}

\begin{methoddesc}{flush}{}
MH メールボックスへの変更は即時に適用されますのでこのメソッドは何もしません。
\end{methoddesc}

\begin{methoddesc}{close}{}
\class{MH} インスタンスは開いたファイルを保持しませんのでこのメソッドは
\method{unlock} と同じです。
\end{methoddesc}

\begin{seealso}
  \seelink{http://www.nongnu.org/nmh/}{nmh - Message Handling System}{
    \program{mh} の改良版である \program{nmh} のホームページ}
  \seelink{http://www.ics.uci.edu/\tilde{}mh/book/}{MH \& nmh: 
    Email for Users \& Programmers}{GPLライセンスの \program{mh} および
    \program{nmh} の本で、このメールボックス形式についての情報があります}
\end{seealso}

\subsubsection{\class{Babyl}}
\label{mailbox-babyl}

\begin{classdesc}{Babyl}{path\optional{, factory=None\optional{, create=True}}}
Babyl 形式のメールボックスのための \class{Mailbox} のサブクラス。
パラメータ \var{factory} は呼び出し可能オブジェクトで
(バイナリモードで開かれているかのように振る舞う)ファイル風メッセージ表現を
受け付けて好みの表現を返すものです。\var{factory} が \code{None}ならば、
\class{BabylMessage} がデフォルトのメッセージ表現として使われます。
\var{create} が \code{True} ならばメールボックスが存在しないときには
作成します。
\end{classdesc}

Babyl は単一ファイルのメールボックス形式で Emacs に付属している Rmail
メールユーザエージェントで使われているものです。メッセージの開始は
Control-Underscore (\character{\textbackslash037}) および Control-L
(\character{\textbackslash014}) の二文字を含む行で示されます。
メッセージの終了は次のメッセージの開始または最後のメッセージの場合には
Control-Underscore を含む行で示されます。

Babyl メールボックス中のメッセージには二つのヘッダのセット、オリジナル
ヘッダといわゆる可視ヘッダ、があります。可視ヘッダは典型的にはオリジナ
ルヘッダの一部を分り易いように再整形したり短くしたりしたもので
す。Babyl メールボックス中のそれぞれのメッセージには \dfn{ラベル} とい
うそのメッセージについての追加情報を記録する短い文字列のリストを伴い、
メールボックス中に見出されるユーザが定義した全てのラベルのリスト
は Babyl オプションセクションに保持されます。

\class{Babyl} インスタンスには \class{Mailbox} の全てのメソッドの他に次のメソッドが
あります。

\begin{methoddesc}{get_labels}{}
メールボックスで使われているユーザが定義した全てのラベルのリストを返します。
\note{メールボックスにどのようなラベルが存在するかを決めるのに、
Babyl オプションセクション のリストを参考にせず、
実際のメッセージを捜索しますが、
Babyl セクションもメールボックスが変更されたときにはいつでも更新されます。}
\end{methoddesc}

\class{Babyl} で実装された \class{Mailbox} のいくつかのメソッドには特別な注意が
必要です。

\begin{methoddesc}{get_file}{key}
Babyl メールボックスにおいて、メッセージのヘッダはボディと繋がって格納されていません。
ファイル風の表現を生成するために、ヘッダとボディが (\module{StringIO} モジュールの)
ファイルと同じ API を持つ \class{StringIO} インスタンスに一緒にコピーされます。
その結果、ファイル風オブジェクトは本当に元にしているメールボックスとは独立していますが、
文字列表現と比べてメモリーを節約することにもなりません。
\end{methoddesc}

\begin{methoddesc}{lock}{}
\methodline{unlock}{}
3種類のロック機構が使われます --- ドットロッキングと、もし使用可能ならば
\cfunction{flock()} と \cfunction{lockf()} システムコールです。
\end{methoddesc}

\begin{seealso}
\seelink{http://quimby.gnus.org/notes/BABYL}{Format of Version 5 Babyl Files}{
Babyl 形式の仕様}
\seelink{http://www.gnu.org/software/emacs/manual/html_node/Rmail.html}{Reading
Mail with Rmail}{Rmail のマニュアルで Babyl のセマンティクスについての情報も少しある}
\end{seealso}

\subsubsection{\class{MMDF}}
\label{mailbox-mmdf}

\begin{classdesc}{MMDF}{path\optional{, factory=None\optional{, create=True}}}
MMDF 形式のメールボックスのための \class{Mailbox} のサブクラス。
パラメータ \var{factory} は呼び出し可能オブジェクトで
(バイナリモードで開かれているかのように振る舞う)ファイル風メッセージ表現を
受け付けて好みの表現を返すものです。\var{factory} が \code{None}ならば、
\class{BabylMessage} がデフォルトのメッセージ表現として使われます。
\var{create} が \code{True} ならばメールボックスが存在しないときには
作成します。
\end{classdesc}

MMDF は単一ファイルのメールボックス形式で Multichannel Memorandum
Distribution Facility というメール転送エージェント用に発明されたものです。
各メッセージは mbox と同様の形式で収められますが、前後を4つの
Control-A (\character{\textbackslash001}) を含む行で挟んであります。
mbox 形式と同じようにそれぞれのメッセージの開始は "From~" の5文字を含む行で
示されますが、それ以外の場所での "From~" は格納の際 ">From~" には変えられません。
それは追加されたメッセージ区切りによって新たなメッセージの開始と見間違うことが
避けられるからです。

\class{MMDF} で実装された \class{Mailbox} のいくつかのメソッドには特別な注意が
必要です。

\begin{methoddesc}{get_file}{key}
\class{MMDF} インスタンスに対し \method{flush()} や \method{close()} を呼び出した
後でファイルを使用すると予期しない結果を引き起こしたり例外が送出されたりすることがあります。
\end{methoddesc}

\begin{methoddesc}{lock}{}
\methodline{unlock}{}
3種類のロック機構が使われます --- ドットロッキングと、もし使用可能ならば
\cfunction{flock()} と \cfunction{lockf()} システムコールです。
\end{methoddesc}

\begin{seealso}
\seelink{http://www.tin.org/bin/man.cgi?section=5\&topic=mmdf}{tin の 
mmdf man page}{ニュースリーダ tin のドキュメント中の MMDF 形式仕様}
\seelink{http://en.wikipedia.org/wiki/MMDF}{MMDF}{Multichannel
Memorandum Distribution Facility についてのウィキペディアの記事}
\end{seealso}

\subsection{\class{Message} objects}
\label{mailbox-message-objects}

\begin{classdesc}{Message}{\optional{message}}
\module{email.Message} モジュールの \class{Message} のサブクラス。
\class{mailbox.Message} のサブクラスはメールボックス形式ごとの状態と動作を
追加します。

\var{message} が省略された場合、新しいインスタンスはデフォルトの空の状態で生成されます。
\var{message} が \class{email.Message.Message} インスタンスならば
その内容がコピーされます。さらに、\var{message} が \class{Message} インスタンス
ならば、形式固有の情報も可能な限り変換されます。\var{message} が文字列または
ファイルならば、読まれ解析されるべき \rfc{2822} 準拠のメッセージを
含んでいなければなりません
\end{classdesc}

サブクラスにより提供される形式ごとの状態と動作は様々ですが、一般に或るメールボックス
に固有のものでないプロパティだけがサポートされます(おそらくプロパティのセットは
メールボックス形式ごとに固有でしょうが)。例えば、単一ファイルメールボックス形式
におけるファイルオフセットやディレクトリ式メールボックス形式におけるファイル名は
保持されません、というのもそれらは元々のメールボックスにしか適用できないからです。
しかし、メッセージがユーザに読まれたかどうかあるいは重要だとマークされたかどうか
という状態は保持されます、というのはそれらはメッセージ自体に適用されるからです。

\class{Mailbox} インスタンスを使って取得したメッセージを表現するのに
\class{Message} インスタンスが使われなければいけないとは要求していません。
ある種の状況では \class{Message} による表現を生成するのに必要な時間やメモリーが
受け入れられないこともあります。そういった状況では \class{Mailbox} インスタンス
は文字列やファイル風オブジェクトの表現も提供できますし、\class{Mailbox} インスタンス
を初期化する際にメッセージファクトリーを指定することもできます。

\subsubsection{\class{MaildirMessage}}
\label{mailbox-maildirmessage}

\begin{classdesc}{MaildirMessage}{\optional{message}}
Maildir 固有の動作をするメッセージ。引数 \var{message} は \class{Message}
のコンストラクタと同じ意味を持ちます。
\end{classdesc}

通常、メールユーザエージェントは \file{new} サブディレクトリにある全ての
メッセージをユーザが最初にメールボックスを開くか閉じるかした後で
\file{cur} サブディレクトリに移動し、メッセージが実際に読まれたかどうかを記録します。
\file{cur} にある各メッセージには状態情報を保存するファイル名に付け加えられた
"info" セクションがあります。(メールリーダの中には "info" セクションを \file{new}
にあるメッセージに付けることもあります。) "info" セクションには二つの形式があります。
一つは "2," の後に標準化されたフラグのリストを付けたもの (たとえば "2,FR")、
もう一つは "1," の後にいわゆる実験的情報を付け加えるものです。
Maildir の標準的なフラグは以下の通りです:

\begin{tableiii}{l|l|l}{textrm}{フラグ}{意味}{説明}
\lineiii{D}{ドラフト(Draft)}{作成中}
\lineiii{F}{フラグ付き(Flagged)}{重要とされたもの}
\lineiii{P}{通過(Passed)}{転送、再送またはバウンス}
\lineiii{R}{返答済み(Replied)}{返答されたもの}
\lineiii{S}{既読(Seen)}{読んだもの}
\lineiii{T}{ごみ(Trashed)}{削除予定とされたもの}
\end{tableiii}

\class{MaildirMessage} インスタンスは以下のメソッドを提供します。

\begin{methoddesc}{get_subdir}{}
"new" (メッセージが \file{new} サブディレクトリに保存されるべき場合)または
"cur" (メッセージが \file{cur} サブディレクトリに保存されるべき場合)のどちらかを
返します。\note{メッセージは通常メールボックスがアクセスされた後、
メッセージが読まれたかどうかに関わらず \file{new} から \file{cur} に移動されます。
メッセージ \code{msg} は \code{"S" not in msg.get_flags()} が \code{True}
ならば読まれています。}
% 反対?
\end{methoddesc}

\begin{methoddesc}{set_subdir}{subdir}
メッセージが保存されるべきサブディレクトリをセットします。パラメータ \var{subdir}
は "new" または "cur" のいずれかでなければなりません。
\end{methoddesc}

\begin{methoddesc}{get_flags}{}
現在セットされているフラグを特定する文字列を返します。メッセージが標準 Maildir 形式に
準拠しているならば、結果はアルファベット順に並べられたゼロまたは1回の \character{D}、
\character{F}、\character{P}、\character{R}、\character{S}、\character{T}
をつなげたものです。空文字列が返されるのはフラグが一つもない場合、または
"info" が実験的セマンティクスを使っている場合です。
\end{methoddesc}

\begin{methoddesc}{set_flags}{flags}
\var{flags} で指定されたフラグをセットし、他のフラグは下ろします。
\end{methoddesc}

\begin{methoddesc}{add_flag}{flag}
\var{flags} で指定されたフラグをセットしますが他のフラグは変えません。
一度に二つ以上のフラグをセットすることは、\var{flag} に2文字以上の文字列を
指定すればできます。現在の "info" はフラグの代わりに実験的情報を使っていても
上書きされます。
\end{methoddesc}

\begin{methoddesc}{remove_flag}{flag}
\var{flags} で指定されたフラグを下ろしますが他のフラグは変えません。
一度に二つ以上のフラグを取り除くことは、\var{flag} に2文字以上の文字列を
指定すればできます。"info" がフラグの代わりに実験的情報を使っている場合は
現在の "info" は書き換えられません。
\end{methoddesc}

\begin{methoddesc}{get_date}{}
メッセージの配送日時をエポックからの秒数を表わす浮動小数点数で返します。
\end{methoddesc}

\begin{methoddesc}{set_date}{date}
メッセージの配送日時を \var{date} にセットします。\var{date} は
エポックからの秒数を表わす浮動小数点数です。
\end{methoddesc}

\begin{methoddesc}{get_info}{}
メッセージの "info" を含む文字列を返します。このメソッドは実験的 (即ちフラグの
リストでない) "info" にアクセスし、また変更するのに役立ちます。
\end{methoddesc}

\begin{methoddesc}{set_info}{info}
"info" に文字列 \var{info} をセットします。
\end{methoddesc}

\class{MaildirMessage} インスタンスが \class{mboxMessage} や \class{MMDFMessage}
のインスタンスに基づいて生成されるとき、\mailheader{Status} および
\mailheader{X-Status} ヘッダは省かれ以下の変換が行われます:

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{mboxMessage} または \class{MMDFMessage} の状態}
\lineii{"cur" サブディレクトリ}{O フラグ}
\lineii{F フラグ}{F フラグ}
\lineii{R フラグ}{A フラグ}
\lineii{S フラグ}{R フラグ}
\lineii{T フラグ}{D フラグ}
\end{tableii}

\class{MaildirMessage} インスタンスが \class{MHMessage} インスタンスに
基づいて生成されるとき、以下の変換が行われます:

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{MHMessage} の状態}
\lineii{"cur" サブディレクトリ}{"unseen" シーケンス}
\lineii{"cur" サブディレクトリおよび S フラグ}{"unseen" シーケンス無し}
\lineii{F フラグ}{"flagged" シーケンス}
\lineii{R フラグ}{"replied" シーケンス}
\end{tableii}

\class{MaildirMessage} インスタンスが \class{BabylMessage} インスタンスに
基づいて生成されるとき、以下の変換が行われます:

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{BabylMessage} の状態}
\lineii{"cur" サブディレクトリ}{"unseen" ラベル}
\lineii{"cur" サブディレクトリおよび S フラグ}{"unseen" ラベル無し}
\lineii{P フラグ}{"forwarded" または "resent" ラベル}
\lineii{R フラグ}{"answered" ラベル}
\lineii{T フラグ}{"deleted" ラベル}
\end{tableii}

\subsubsection{\class{mboxMessage}}
\label{mailbox-mboxmessage}

\begin{classdesc}{mboxMessage}{\optional{message}}
mbox 固有の動作をするメッセージ。引数 \var{message} は \class{Message}
のコンストラクタと同じ意味を持ちます。
\end{classdesc}

mbox メールボックス中のメッセージは単一ファイルにまとめて格納されています。
送り主のエンベロープアドレスおよび配送日時は通常メッセージの開始を示す "From~" から
始まる行に記録されますが、正確なフォーマットに関しては mbox の実装ごとに
大きな違いがあります。メッセージの状態を示すフラグ、たとえば読んだかどうかあるいは
重要だとマークを付けられているかどうかといったようなもの、は典型的には
\mailheader{Status} および \mailheader{X-Status} に収められます。

規定されている mbox メッセージのフラグは以下の通りです:

\begin{tableiii}{l|l|l}{textrm}{フラグ}{意味}{説明}
\lineiii{R}{既読(Read)}{読んだ}
\lineiii{O}{古い(Old)}{以前に MUA に発見された}
\lineiii{D}{削除(Deleted)}{削除予定}
\lineiii{F}{フラグ付き(Flagged)}{重要だとマークされた}
\lineiii{A}{返答済み(Answered)}{返答した}
\end{tableiii}

"R" および "O" フラグは \mailheader{Status} ヘッダに記録され、
"D"、"F"、"A" フラグは \mailheader{X-Status} ヘッダに記録されます。
フラグとヘッダは通常記述された順番に出現します。

\class{mboxMessage} インスタンスは以下のメソッドを提供します:

\begin{methoddesc}{get_from}{}
mbox メールボックスのメッセージの開始を示す "From~" 行を表わす文字列を返します。
先頭の "From~" および末尾の改行は含まれません。
\end{methoddesc}

\begin{methoddesc}{set_from}{from_\optional{, time_=None}}
"From~" 行を \var{from_} にセットします。\var{from_} は先頭の "From~" や
末尾の改行を含まない形で指定しなければなりません。利便性のために、\var{time_}
を指定して適切に整形して \var{from_} に追加させることができます。\var{time_}
を指定する場合、それは \class{struct_time} インスタンス、\method{time.strftime()}
に渡すのに適したタプル、または \code{True} (この場合 \method{time.gmtime()}
を使います)のいずれかでなければなりません。
\end{methoddesc}

\begin{methoddesc}{get_flags}{}
現在セットされているフラグを特定する文字列を返します。メッセージが規定された形式に
準拠しているならば、結果は次の順に並べられたゼロまたは1回の \character{R}、
\character{O}、\character{D}、\character{F}、\character{A} です。
\end{methoddesc}

\begin{methoddesc}{set_flags}{flags}
\var{flags} で指定されたフラグをセットして、他のフラグは下ろします。
\var{flags} は並べられたゼロまたは1回の \character{R}、
\character{O}、\character{D}、\character{F}、\character{A} です。
\end{methoddesc}

\begin{methoddesc}{add_flag}{flag}
\var{flags} で指定されたフラグをセットしますが他のフラグは変えません。
一度に二つ以上のフラグをセットすることは、\var{flag} に2文字以上の文字列を
指定すればできます。\end{methoddesc}

\begin{methoddesc}{remove_flag}{flag}
\var{flags} で指定されたフラグを下ろしますが他のフラグは変えません。
一度に二つ以上のフラグを取り除くことは、\var{flag} に2文字以上の文字列を
指定すればできます。
\end{methoddesc}

\class{mboxMessage} インスタンスが \class{MaildirMessage} インスタンスに
基づいて生成されるとき、\class{MaildirMessage} インスタンスの配送日時に基づいて
"From~" 行が作り出され、次の変換が行われます:

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{MaildirMessage} の状態}
\lineii{R フラグ}{S フラグ}
\lineii{O フラグ}{"cur" サブディレクトリ}
\lineii{D フラグ}{T フラグ}
\lineii{F フラグ}{F フラグ}
\lineii{A フラグ}{R フラグ}
\end{tableii}

\class{mboxMessage} インスタンスが \class{MHMessage} インスタンスに
基づいて生成されるとき、以下の変換が行われます。

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{MHMessage} 状態}
\lineii{R フラグ および O フラグ}{"unseen" シーケンス無し}
\lineii{O フラグ}{"unseen" シーケンス}
\lineii{F フラグ}{"flagged" シーケンス}
\lineii{A フラグ}{"replied" シーケンス}
\end{tableii}

\class{mboxMessage} インスタンスが \class{BabylMessage} インスタンスに
基づいて生成されるとき、以下の変換が行われます:

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{BabylMessage} の状態}
\lineii{R フラグ および O フラグ}{"unseen" ラベル無し}
\lineii{O フラグ}{"unseen" ラベル}
\lineii{D フラグ}{"deleted" ラベル}
\lineii{A フラグ}{"answered" ラベル}
\end{tableii}

\class{mboxMessage} インスタンスが \class{MMDFMessage} インスタンスに
基づいて生成されるとき、"From~" 行はコピーされ全てのフラグは直接対応します:

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{MMDFMessage} の状態}
\lineii{R フラグ}{R フラグ}
\lineii{O フラグ}{O フラグ}
\lineii{D フラグ}{D フラグ}
\lineii{F フラグ}{F フラグ}
\lineii{A フラグ}{A フラグ}
\end{tableii}

\subsubsection{\class{MHMessage}}
\label{mailbox-mhmessage}

\begin{classdesc}{MHMessage}{\optional{message}}
MH 固有の動作をするメッセージ。引数 \var{message} は \class{Message}
のコンストラクタと同じ意味を持ちます。
\end{classdesc}

MH メッセージは伝統的な意味あいにおいてマークやフラグをサポートしません。
しかし、MH メッセージにはシーケンスがあり任意のメッセージを論理的にグループ分けできます。
いくつかのメールソフト(標準の \program{mh} や \program{nmh} はそうではありませんが)
は他の形式におけるフラグとほぼ同じようにシーケンスを使います。

\begin{tableii}{l|l}{textrm}{シーケンス}{説明}
\lineii{unseen}{読んではいないが既にMUAに見つけられている}
\lineii{replied}{返答した}
\lineii{flagged}{重要だとマークされた}
\end{tableii}

\class{MHMessage} インスタンスは以下のメソッドを提供します:

\begin{methoddesc}{get_sequences}{}
このメッセージを含むシーケンスの名前のリストを返す。
\end{methoddesc}

\begin{methoddesc}{set_sequences}{sequences}
このメッセージを含むシーケンスのリストをセットする。
\end{methoddesc}

\begin{methoddesc}{add_sequence}{sequence}
\var{sequence} をこのメッセージを含むシーケンスのリストに追加する。
\end{methoddesc}

\begin{methoddesc}{remove_sequence}{sequence}
\var{sequence} をこのメッセージを含むシーケンスのリストから除く。
\end{methoddesc}

\class{MHMessage} インスタンスが \class{MaildirMessage} インスタンスに
基づいて生成されるとき、以下の変換が行われます:

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{MaildirMessage} の状態}
\lineii{"unseen" シーケンス}{S フラグ無し}
\lineii{"replied" シーケンス}{R フラグ}
\lineii{"flagged" シーケンス}{F フラグ}
\end{tableii}

\class{MHMessage} インスタンスが \class{mboxMessage} や \class{MMDFMessage}
のインスタンスに基づいて生成されるとき、\mailheader{Status} および
\mailheader{X-Status} ヘッダは省かれ以下の変換が行われます:

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{mboxMessage} または \class{MMDFMessage} の状態}
\lineii{"unseen" シーケンス}{R フラグ無し}
\lineii{"replied" シーケンス}{A フラグ}
\lineii{"flagged" シーケンス}{F フラグ}
\end{tableii}

\class{MHMessage} インスタンスが \class{BabylMessage} インスタンスに
基づいて生成されるとき、以下の変換が行われます:

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{BabylMessage} の状態}
\lineii{"unseen" シーケンス}{"unseen" ラベル}
\lineii{"replied" シーケンス}{"answered" ラベル}
\end{tableii}

\subsubsection{\class{BabylMessage}}
\label{mailbox-babylmessage}

\begin{classdesc}{BabylMessage}{\optional{message}}
Babyl 固有の動作をするメッセージ。引数 \var{message} は \class{Message}
のコンストラクタと同じ意味を持ちます。
\end{classdesc}

ある種のメッセージラベルは \dfn{アトリビュート} と呼ばれ、規約により特別な意味が
与えられています。アトリビュートは以下の通りです:

\begin{tableii}{l|l}{textrm}{ラベル}{説明}
\lineii{unseen}{読んでいないが既に MUA に見つかっている}
\lineii{deleted}{削除予定}
\lineii{filed}{他のファイルまたはメールボックスにコピーされた}
\lineii{answered}{返答済み}
\lineii{forwarded}{転送された}
\lineii{edited}{ユーザによって変更された}
\lineii{resent}{再送された}
\end{tableii}

デフォルトでは Rmail は可視ヘッダのみ表示する。\class{BabylMessage} クラスはしかし、
オリジナルヘッダをより完全だという理由で使います。可視ヘッダは望むならそのように
指示してアクセスすることができます。

\class{BabylMessage} インスタンスは以下のメソッドを提供します:

\begin{methoddesc}{get_labels}{}
メッセージに付いているラベルのリストを返します。
\end{methoddesc}

\begin{methoddesc}{set_labels}{labels}
メッセージに付いているラベルのリストを \var{labels} にセットします。
\end{methoddesc}

\begin{methoddesc}{add_label}{label}
メッセージに付いているラベルのリストに \var{label} を追加します。
\end{methoddesc}

\begin{methoddesc}{remove_label}{label}
メッセージに付いているラベルのリストから \var{label} を削除します。
\end{methoddesc}

\begin{methoddesc}{get_visible}{}
ヘッダがメッセージの可視ヘッダでありボディが空であるような \class{Message}
インスタンスを返します。
\end{methoddesc}

\begin{methoddesc}{set_visible}{visible}
メッセージの可視ヘッダを \var{visible} のヘッダと同じにセットします。
引数 \var{visible} は \class{Message} インスタンスまたは
\class{email.Message.Message} インスタンス、
文字列、ファイル風オブジェクト(テキストモードで開かれてなければなりません)のいずれかです。
\end{methoddesc}

\begin{methoddesc}{update_visible}{}
\class{BabylMessage} インスタンスのオリジナルヘッダが変更されたとき、可視ヘッダは
自動的に対応して変更されるわけではありません。このメソッドは可視ヘッダを以下のように
更新します。
対応するオリジナルヘッダのある可視ヘッダはオリジナルヘッダの値がセットされます。
対応するオリジナルヘッダの無い可視ヘッダは除去されます。
そして、オリジナルヘッダにあって可視ヘッダに無い \mailheader{Date}、
\mailheader{From}、\mailheader{Reply-To}、\mailheader{To}、
\mailheader{CC}、\mailheader{Subject} は可視ヘッダに追加されます。
\end{methoddesc}

\class{BabylMessage} インスタンスが \class{MaildirMessage} インスタンスに
基づいて生成されるとき、以下の変換が行われます:

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{MaildirMessage} の状態}
\lineii{"unseen" ラベル}{S フラグ無し}
\lineii{"deleted" ラベル}{T フラグ}
\lineii{"answered" ラベル}{R フラグ}
\lineii{"forwarded" ラベル}{P フラグ}
\end{tableii}

\class{BabylMessage} インスタンスが \class{mboxMessage} や \class{MMDFMessage}
のインスタンスに基づいて生成されるとき、\mailheader{Status} および
\mailheader{X-Status} ヘッダは省かれ以下の変換が行われます:

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{mboxMessage} または \class{MMDFMessage} の状態}
\lineii{"unseen" ラベル}{R フラグ無し}
\lineii{"deleted" ラベル}{D フラグ}
\lineii{"answered" ラベル}{A フラグ}
\end{tableii}

\class{BabylMessage} インスタンスが \class{MHMessage} インスタンスに
基づいて生成されるとき、以下の変換が行われます:

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{MHMessage} の状態}
\lineii{"unseen" ラベル}{"unseen" シーケンス}
\lineii{"answered" ラベル}{"replied" シーケンス}
\end{tableii}

\subsubsection{\class{MMDFMessage}}
\label{mailbox-mmdfmessage}

\begin{classdesc}{MMDFMessage}{\optional{message}}
MMDF 固有の動作をするメッセージ。引数 \var{message} は \class{Message}
のコンストラクタと同じ意味を持ちます。
\end{classdesc}

mbox メールボックスのメッセージと同様に、MMDF メッセージは送り主のアドレスと配送日時が
最初の "From~" で始まる行に記録されています。同様に、メッセージの状態を示すフラグは
通常 \mailheader{Status} および \mailheader{X-Status} ヘッダに収められています。

よく使われる MMDF メッセージのフラグは mbox メッセージのものと同一で以下の通りです:

\begin{tableiii}{l|l|l}{textrm}{フラグ}{意味}{説明}
\lineiii{R}{既読(Read)}{読んだ}
\lineiii{O}{古い(Old)}{以前に MUA に発見された}
\lineiii{D}{削除(Deleted)}{削除予定}
\lineiii{F}{フラグ付き(Flagged)}{重要だとマークされた}
\lineiii{A}{返答済み(Answered)}{返答した}
\end{tableiii}

"R" および "O" フラグは \mailheader{Status} ヘッダに記録され、
"D"、"F"、"A" フラグは \mailheader{X-Status} ヘッダに記録されます。
フラグとヘッダは通常記述された順番に出現します。

\class{MMDFMessage} インスタンスは \class{mboxMessage} インスタンスと同一の
以下のメソッドを提供します:

\begin{methoddesc}{get_from}{}
MMDF メールボックスのメッセージの開始を示す "From~" 行を表わす文字列を返します。
先頭の "From~" および末尾の改行は含まれません。
\end{methoddesc}

\begin{methoddesc}{set_from}{from_\optional{, time_=None}}
"From~" 行を \var{from_} にセットします。\var{from_} は先頭の "From~" や
末尾の改行を含まない形で指定しなければなりません。利便性のために、\var{time_}
を指定して適切に整形して \var{from_} に追加させることができます。\var{time_}
を指定する場合、それは \class{struct_time} インスタンス、\method{time.strftime()}
に渡すのに適したタプル、または \code{True} (この場合 \method{time.gmtime()}
を使います)のいずれかでなければなりません。
\end{methoddesc}

\begin{methoddesc}{get_flags}{}
現在セットされているフラグを特定する文字列を返します。メッセージが規定された形式に
準拠しているならば、結果は次の順に並べられたゼロまたは1回の \character{R}、
\character{O}、\character{D}、\character{F}、\character{A} です。
\end{methoddesc}

\begin{methoddesc}{set_flags}{flags}
\var{flags} で指定されたフラグをセットして、他のフラグは下ろします。
\var{flags} は並べられたゼロまたは1回の \character{R}、
\character{O}、\character{D}、\character{F}、\character{A} です。
\end{methoddesc}

\begin{methoddesc}{add_flag}{flag}
\var{flags} で指定されたフラグをセットしますが他のフラグは変えません。
一度に二つ以上のフラグをセットすることは、\var{flag} に2文字以上の文字列を
指定すればできます。\end{methoddesc}

\begin{methoddesc}{remove_flag}{flag}
\var{flags} で指定されたフラグを下ろしますが他のフラグは変えません。
一度に二つ以上のフラグを取り除くことは、\var{flag} に2文字以上の文字列を
指定すればできます。
\end{methoddesc}

\class{MMDFMessage} インスタンスが \class{MaildirMessage} インスタンスに
基づいて生成されるとき、\class{MaildirMessage} インスタンスの配送日時に基づいて
"From~" 行が作り出され、次の変換が行われます:

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{MaildirMessage} の状態}
\lineii{R フラグ}{S フラグ}
\lineii{O フラグ}{"cur" サブディレクトリ}
\lineii{D フラグ}{T フラグ}
\lineii{F フラグ}{F フラグ}
\lineii{A フラグ}{R フラグ}
\end{tableii}

\class{MMDFMessage} インスタンスが \class{MHMessage} インスタンスに
基づいて生成されるとき、以下の変換が行われます。

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{MHMessage} 状態}
\lineii{R フラグ および O フラグ}{"unseen" シーケンス無し}
\lineii{O フラグ}{"unseen" シーケンス}
\lineii{F フラグ}{"flagged" シーケンス}
\lineii{A フラグ}{"replied" シーケンス}
\end{tableii}

\class{MMDFMessage} インスタンスが \class{BabylMessage} インスタンスに
基づいて生成されるとき、以下の変換が行われます:

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{BabylMessage} の状態}
\lineii{R フラグ および O フラグ}{"unseen" ラベル無し}
\lineii{O フラグ}{"unseen" ラベル}
\lineii{D フラグ}{"deleted" ラベル}
\lineii{A フラグ}{"answered" ラベル}
\end{tableii}

\class{MMDFMessage} インスタンスが \class{mboxMessage} インスタンスに
基づいて生成されるとき、"From~" 行はコピーされ全てのフラグは直接対応します:

\begin{tableii}{l|l}{textrm}
    {結果の状態}{\class{mboxMessage} の状態}
\lineii{R フラグ}{R フラグ}
\lineii{O フラグ}{O フラグ}
\lineii{D フラグ}{D フラグ}
\lineii{F フラグ}{F フラグ}
\lineii{A フラグ}{A フラグ}
\end{tableii}

\subsection{例外}
%\label{mailbox-deprecated} <- 間違いでしょう
\label{mailbox-exceptions}

\module{mailbox} モジュールでは以下の例外クラスが定義されています:

\begin{classdesc}{Error}{}
他の全てのモジュール固有の例外の基底クラス。
\end{classdesc}

\begin{classdesc}{NoSuchMailboxError}{}
メールボックスがあると思っていたが見つからなかった場合に送出されます。
これはたとえば \class{Mailbox} のサブクラスを存在しないパスでインスタンス化しようと
したとき(かつ \var{create} パラメータは \code{False} であった場合)、
あるいは存在しないフォルダを開こうとした時などに発生します。
\end{classdesc}

\begin{classdesc}{NotEmptyError}{}
メールボックスが空であることを期待されているときに空でない場合、たとえばメッセージの
残っているフォルダを削除しようとした時などに送出されます。
\end{classdesc}

\begin{classdesc}{ExternalClashError}{}
メールボックスに関係したある条件がプログラムの制御を外れてそれ以上作業を
続けられなくなった場合、たとえば他のプログラムが既に保持しているロックを取得しようとして
失敗したとき、あるいは一意的に生成されたファイル名が既に存在していた場合などに
送出されます。
\end{classdesc}

\begin{classdesc}{FormatError}{}
ファイル中のデータが解析できない場合、たとえば \class{MH} インスタンスが
壊れた \file{.mh_sequences} ファイルを読もうと試みた場合などに送出されます。
\end{classdesc}

\subsection{撤廃されたクラスとメソッド}
\label{mailbox-deprecated}

古いバージョンの \module{mailbox} モジュールはメッセージの追加や削除といった
メールボックスの変更をサポートしていませんでした。また形式ごとのメッセージプロパティ
を表現するクラスも提供していませんでした。後方互換性のために、古いメールボックス
クラスもまだ使うことができますが、できるだけ新しいクラスを使うべきです。

古いメールボックスオブジェクトは繰り返しと一つの公開メソッドだけを提供していました:

\begin{methoddesc}[oldmailbox]{next}{}
メールボックスオブジェクトのコンストラクタに渡された、オプションの
\var{factory} 引数を使って、メールボックス中の次のメッセージを
生成して返します。標準の設定では、\var{factory} は \class{rfc822.Message}
オブジェクトです (\refmodule{rfc822} モジュールを参照してください)。
メールボックスの実装により、このオブジェクトの \var{fp} 属性は
真のファイルオブジェクトかもしれないし、
複数のメールメッセージが単一のファイルに収められているなどの場合に、
メッセージ間の境界を注意深く扱うためにファイルオブジェクトをシミュレート
するクラスのインスタンスであるかもしれません。
次のメッセージがない場合、このメソッドは \code{None} を返します。
\end{methoddesc}

ほとんどの古いメールボックスクラスは現在のメールボックスクラスと違う名前ですが、
\class{Maildir} だけは例外です。そのため、新しい方の \class{Maildir} クラスには
\method{next()} メソッドが定義され、コンストラクタも他の新しいメールボックスクラスとは
少し異なります。

古いメールボックスのクラスで名前が新しい対応物と同じでないものは以下の通りです:

\begin{classdesc}{UnixMailbox}{fp\optional{, factory}}
全てのメッセージが単一のファイルに収められ、\samp{From } 
(\samp{From_} として知られています) 行によって分割されているような、
旧来の \UNIX 形式のメールボックスにアクセスします。
ファイルオブジェクト \var{fp} はメールボックスファイルを指します。
オプションの \var{factory} パラメタは新たなメッセージオブジェクト
を生成するような呼び出し可能オブジェクトです。\var{factory} は、
メールボックスオブジェクトに対して \method{next()} メソッドを実行
した際に、単一の引数、\var{fp} を伴って呼び出されます。
この引数の標準の値は \class{rfc822.Message} クラスです
(\refmodule{rfc822} モジュール -- および以下 -- を参照してください)。

\begin{notice}
  このモジュールの実装上の理由により、\var{fp} オブジェクトはバイナリ
  モードで開くようにしてください。特にWindows上では注意が必要です。
\end{notice}

可搬性を最大限にするために、\UNIX 形式のメールボックス内にある
メッセージは、正確に \code{'From '} (末尾の空白に注意してください) 
で始まる文字列が、直前の正しく二つの改行の後にくるような行で
分割されます。現実的には広範なバリエーションがあるため、それ以外の
From_ 行について考慮すべきではないのですが、現在の実装では先頭の
二つの改行をチェックしていません。これはほとんどのアプリケーションで
うまく動作します。

\class{UnixMailbox} クラスでは、ほぼ正確に From_ デリミタにマッチする
ような正規表現を用いることで、より厳密に From_ 行のチェックを行う
バージョンを実装しています。\class{UnixMailbox} ではデリミタ行が
\samp{From \var{name} \var{time}} の行に分割されるものと考えます。
可搬性を最大限にするためには、代わりに \class{PortableUnixMailbox} 
クラスを使ってください。このクラスは \class{UnixMailbox} と同じですが、
個々のメッセージは \samp{From } 行だけで分割されるものとみなします。

より詳細な情報については、
\citetitle[http://home.netscape.com/eng/mozilla/2.0/relnotes/demo/content-length.html]{Configuring
Netscape Mail on \UNIX: Why the Content-Length Format is Bad}
を参照してください。
\end{classdesc}

\begin{classdesc}{PortableUnixMailbox}{fp\optional{, factory}}
厳密性の低い \class{UnixMailbox} のバージョンで、メッセージを分割
する行は \samp{From } のみであると見なします。実際に見られるメール
ボックスのバリエーションに対応するため、 From 行における
``\var{name} \var{time}'' 部分は無視されます。メール処理ソフトウェア
はメッセージ中の \code{'From '} で始まる行をクオートするため、
この分割はうまく動作します。
\end{classdesc}

\begin{classdesc}{MmdfMailbox}{fp\optional{, factory}}
全てのメッセージが単一のファイルに収められ、4 つの control-A 文字
によって分割されているような、MMDF 形式のメールボックスにアクセスします。
ファイルオブジェクト \var{fp} はメールボックスファイルをさします。
オプションの \var{factory} は \class{UnixMailbox} クラスにおけるのと
同様です。
\end{classdesc}

\begin{classdesc}{MHMailbox}{dirname\optional{, factory}}
数字で名前のつけられた別々のファイルに個々のメッセージを収めた
ディレクトリである、MH メールボックスにアクセスします。
メールボックスディレクトリの名前は \var{dirname} で渡します。
\var{factory} は \class{UnixMailbox} クラスにおけるのと
同様です。
\end{classdesc}

\begin{classdesc}{BabylMailbox}{fp\optional{, factory}}
MMDF メールボックスと似ている、Babyl メールボックスにアクセスします。
Babyl 形式では、各メッセージは二つのヘッダからなるセット、
\emph{original} ヘッダおよび \emph{visible} ヘッダをを持っています。
original ヘッダは \code{'*** EOOH ***'} (End-Of-Original-Headers) 
だけを含む行の前にあり、visible ヘッダは \code{EOOH} 行の後に
あります。Babyl 互換のメールリーダは visible ヘッダのみを表示
し、 \class{BabylMailbox} オブジェクトは visible ヘッダのみを
含むようなメッセージを返します。メールメッセージは EOOH 行で始まり、
\code{'\e{}037\e{}014'} だけを含む行で終わります。
\var{factory} は \class{UnixMailbox} クラスにおけるのと
同様です。
\end{classdesc}

古いメールボックスクラスを撤廃された \refmodule{rfc822} モジュールではなく、
\refmodule{email} モジュールと使いたいならば、以下のようにできます:

\begin{verbatim}
import email
import email.Errors
import mailbox

def msgfactory(fp):
    try:
        return email.message_from_file(fp)
    except email.Errors.MessageParseError:
        # Don't return None since that will
        # stop the mailbox iterator
        return ''

mbox = mailbox.UnixMailbox(fp, msgfactory)
\end{verbatim}

一方、メールボックス内には正しい形式の MIME メッセージしか入っていないと
分かっているのなら、単に以下のようにします:

\begin{verbatim}
import email
import mailbox

mbox = mailbox.UnixMailbox(fp, email.message_from_file)
\end{verbatim}

\subsection{例}
\label{mailbox-examples}

メールボックス中の面白そうなメッセージのサブジェクトを全て印字する簡単な例:

\begin{verbatim}
import mailbox
for message in mailbox.mbox('~/mbox'):
    subject = message['subject']       # Could possibly be None.
    if subject and 'python' in subject.lower():
        print subject
\end{verbatim}

Babyl メールボックスから MH メールボックスへ全てのメールをコピーし、
変換可能な全ての形式固有の情報を変換する:

\begin{verbatim}
import mailbox
destination = mailbox.MH('~/Mail')
for message in mailbox.Babyl('~/RMAIL'):
    destination.add(MHMessage(message))
\end{verbatim}

幾つかのメーリングリストのメールをソートする例。
他のプログラムと平行して変更を加えることでメールが破損したり、
プログラムを中断することでメールを失ったり、
はたまた半端なメッセージがメールボックス中にあることで途中で終了してしまう、
といったことを避けるように注意深く扱っている:

\begin{verbatim}
import mailbox
import email.Errors
list_names = ('python-list', 'python-dev', 'python-bugs')
boxes = dict((name, mailbox.mbox('~/email/%s' % name)) for name in list_names)
inbox = mailbox.Maildir('~/Maildir', None)
for key in inbox.iterkeys():
    try:
        message = inbox[key]
    except email.Errors.MessageParseError:
        continue                # The message is malformed. Just leave it.
    for name in list_names:
        list_id = message['list-id']
        if list_id and name in list_id:
            box = boxes[name]
            box.lock()
            box.add(message)
            box.flush()         # Write copy to disk before removing original.
            box.unlock()
            inbox.discard(key)
            break               # Found destination, so stop looking.
for box in boxes.itervalues():
    box.close()
\end{verbatim}

