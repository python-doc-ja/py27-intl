\section{\module{BaseHTTPServer} ---
         基本的な機能を持つ HTTP サーバ}

\declaremodule{standard}{BaseHTTPServer}
\modulesynopsis{基本的な機能を持つ HTTP サーバ 
(\class{SimpleHTTPServer} および \class{CGIHTTPServer} の基底クラス)。}


\indexii{WWW}{server}
\indexii{HTTP}{protocol}
\index{URL}
\index{httpd}

このモジュールでは、 HTTP サーバ (Web サーバ) を実装するための
二つののクラスを定義しています。通常、このモジュールが直接使用
されることはなく、特定の機能を持つ Web サーバを構築するために
使われます。
\refmodule{SimpleHTTPServer}\refstmodindex{SimpleHTTPServer} および
\refmodule{CGIHTTPServer}\refstmodindex{CGIHTTPServer} モジュール
を参照してください。

最初のクラス、\class{HTTPServer} は \class{SocketServer.TCPServer} 
のサブクラスです。\class{HTTPServer} は HTTP ソケットを生成して
リクエスト待ち (listen) を行い、リクエストをハンドラに渡します。
サーバを作成して動作させるためのコードは以下のようになります:

\begin{verbatim}
def run(server_class=BaseHTTPServer.HTTPServer,
        handler_class=BaseHTTPServer.BaseHTTPRequestHandler):
    server_address = ('', 8000)
    httpd = server_class(server_address, handler_class)
    httpd.serve_forever()
\end{verbatim}

\begin{classdesc}{HTTPServer}{server_address, RequestHandlerClass}
このクラスは \class{TCPServer} 型のクラスの上に構築されており、
サーバのアドレスをインスタンス変数 \member{server_name}
および \member{server_port} に記憶します。サーバはハンドラから
アクセス可能で、通常 \member{server} インスタンス変数でアクセス
します。
\end{classdesc}

\begin{classdesc}{BaseHTTPRequestHandler}{request, client_address, server}
このクラスはサーバに到着したリクエストを処理します。このメソッド
自体では、実際のリクエストに応答することはできません; 
(GET や POST のような) 各リクエストメソッドを処理するためには
サブクラス化しなければなりません。
\class{BaseHTTPRequestHandler} では、サブクラスで使うための
クラスやインスタンス変数、メソッド群を数多く提供しています。

このハンドラはリクエストを解釈し、次いでリクエスト形式ごとに固有の
メソッドを呼び出します。メソッド名はリクエストの名称から構成
されます。例えば、リクエストメソッド \samp{SPAM} に対しては、
\method{do_SPAM()} メソッドが引数なしで呼び出されます。
リクエストに関連する情報は全て、ハンドラのインスタンス変数
に記憶されています。サブクラスでは \method{__init__()} メソッドを
上書きしたり拡張したりする必要はありません。
\end{classdesc}


\class{BaseHTTPRequestHandler} は以下のインスタンス変数を持っています:

\begin{memberdesc}{client_address}
HTTP クライアントのアドレスを参照している、
\code{(\var{host}, \var{port})} の形式をとるタプルが入っています。
\end{memberdesc}

\begin{memberdesc}{command}
HTTP 命令 (リクエスト形式) が入っています。例えば \code{'GET'} です。
\end{memberdesc}

\begin{memberdesc}{path}
リクエストされたパスが入っています。
\end{memberdesc}

\begin{memberdesc}{request_version}
リクエストのバージョン文字列が入っています。例えば \code{'HTTP/1.0'}
です。
\end{memberdesc}

\begin{memberdesc}{headers}
\member{MessageClass} クラス変数で指定されたクラスのインスタンス
を保持しています。このインスタンスは HTTP リクエストのヘッダを
解釈し、管理しています。
\end{memberdesc}

\begin{memberdesc}{rfile}
入力ストリームが入っており、そのファイルポインタはオプション
入力データ部の先頭を指しています。
\end{memberdesc}

\begin{memberdesc}{wfile}
クライアントに返送する応答を書き込むための出力ストリームが
入っています。このストリームに書き込む際には、HTTP プロトコル
に従った形式をとらなければなりません。
\end{memberdesc}


\class{BaseHTTPRequestHandler} は以下のクラス変数を持っています:

\begin{memberdesc}{server_version}
サーバのソフトウェアバージョンを指定します。
この値は上書きする必要が生じるかもしれません。
書式は複数の文字列を空白で分割したもので、各文字列は
ソフトウェア名[/バージョン] の形式をとります。
例えば、\code{'BaseHTTP/0.2'} です。
\end{memberdesc}

\begin{memberdesc}{sys_version}
Python 処理系のバージョンが、\member{version_string} メソッドや
\member{server_version} クラス変数で利用可能な形式で入っています。
例えば \code{'Python/1.4'} です。
\end{memberdesc}

\begin{memberdesc}{error_message_format}
クライアントに返すエラー応答を構築するための書式化文字列を指定
します。この文字列は丸括弧で囲ったキー文字列で指定する形式を
使うので、書式化の対象となる値は辞書でなければなりません。
キー \var{code} は整数で、HTTP エラーコードを特定する数値です。
\var{message} は文字列で、何が発生したかを表す (詳細な) 
エラーメッセージが入ります。\var{explain} はエラーコード番号
の説明です。\var{message} および \var{explain} の標準の値は
\var{response} クラス変数でみつけることができます。
\end{memberdesc}

\begin{memberdesc}{protocol_version}
この値には応答に使われる HTTP プロトコルのバージョンを指定します。
\code{'HTTP/1.1'} に設定されると、サーバは持続的 HTTP 接続を
許可します; しかしその場合、サーバは全てのクライアントに対する
応答に、正確な値を持つ \code{Content-Length} ヘッダを 
(\method{send_header()} を使って) 含め \emph{なければなりません}。
以前のバージョンとの互換性を保つため、標準の設定値は
\code{'HTTP/1.0'} です。
\end{memberdesc}

\begin{memberdesc}{MessageClass}
HTTP ヘッダを解釈するための \class{rfc822.Message} 類似のクラスを
指定します。通常この値が上書きされることはなく、標準の値
\class{mimetools.Message} になっています。
\withsubitem{(in module mimetools)}{\ttindex{Message}}
\end{memberdesc}

\begin{memberdesc}{responses}
この変数はエラーコードを表す整数を二つの要素をもつタプルに対応付け
ます。タプルには短いメッセージと長いメッセージが入っています。
例えば、
\code{\{\var{code}: (\var{shortmessage}, \var{longmessage})\}}
といったようになります。\var{shortmessage} は通常、エラー応答に
おける \var{message} キーの値として使われ、\var{longmessage} 
は \var{explain} キーの値として使われます
(\member{error_message_format} クラス変数を参照してください) 。
\end{memberdesc}


\class{BaseHTTPRequestHandler} インスタンスは以下のメソッドを持っています:

\begin{methoddesc}{handle}{}
\method{handle_one_request()} を一度だけ (持続的接続が有効になって
いる場合には複数回) 呼び出して、HTTP リクエストを処理します。
このメソッドを上書きする必要はまったくありません; そうする代わりに
適切な \method{do_*()} を実装してください。
\end{methoddesc}

\begin{methoddesc}{handle_one_request}{}
このメソッドはリクエストを解釈し、適切な \method{do_*()} メソッドに
転送します。このメソッドを上書きする必要はまったくありません。
\end{methoddesc}

\begin{methoddesc}{send_error}{code\optional{, message}}
完全なエラー応答をクライアントに送信し、ログ記録します。
\var{code} は数値型で、 HTTP エラーコードを指定します。
\var{message} はオプションで、より詳細なメッセージテキストです。
完全なヘッダのセットが送信された後、\member{error_message_format}
クラス変数を使って組み立てられたテキストが送られます。
\end{methoddesc}

\begin{methoddesc}{send_response}{code\optional{, message}}
応答ヘッダを送信し、受理したリクエストをログ記録します。HTTP
応答行が送られた後、\emph{Server} および \emph{Date} ヘッダが
送られます。これら二つのヘッダはそれぞれ \method{version_string()} 
および \method{date_time_string()} メソッドで取り出します。
\end{methoddesc}

\begin{methoddesc}{send_header}{keyword, value}
出力ストリームに特定の HTTP ヘッダを書き込みます。\var{keyword}
はヘッダのキーワードを指定し、\var{value} にはその値を指定します。
\end{methoddesc}

\begin{methoddesc}{end_headers}{}
応答中の HTTP ヘッダの終了を示す空行を送信します。
\end{methoddesc}

\begin{methoddesc}{log_request}{\optional{code\optional{, size}}}
受理された (成功した) リクエストをログに記録します。\var{code} には
この応答に関連付けられた HTTP コード番号を指定します。
応答メッセージの大きさを知ることができる場合、\var{size} パラメタ
に渡すとよいでしょう。
\end{methoddesc}

\begin{methoddesc}{log_error}{...}
リクエストを遂行できなかった際に、エラーをログに記録します。
標準では、メッセージを \method{log_message()} に渡します。
従って同じ引数 (\var{format} と追加の値) を取ります。
\end{methoddesc}

\begin{methoddesc}{log_message}{format, ...}
任意のメッセージを \code{sys.stderr} にログ記録します。
このメソッドは通常、カスタムのエラーログ記録機構を作成するために
上書きされます。\var{format} 引数は標準の printf 形式の書式化
文字列で、\method{log_message()} に渡された追加の引数は
書式化の入力として適用されます。ログ記録される全てのメッセージ
には、クライアントのアドレスおよび現在の日付、時刻が先頭に
付けられます。
\end{methoddesc}

\begin{methoddesc}{version_string}{}
サーバソフトウェアのバージョン文字列を返します。この文字列は
クラス変数 \member{server_version} および \member{sys_version} 
を組み合わせたものです。
\end{methoddesc}

\begin{methoddesc}{date_time_string}{\optional{timestamp}}
メッセージヘッダ向けに書式化された、
\var{timestamp}(\function{time.time()}のフォーマットである必要があります)で与えられた日時を返します。
もし \var{timestamp} が省略された場合には、現在の日時が使われます。

出力は \code{'Sun, 06 Nov 1994 08:49:37 GMT'} のようになります。
\versionadded[\var{timestamp} パラメータ]{2.5}
\end{methoddesc}

\begin{methoddesc}{log_date_time_string}{}
ログ記録向けに書式化された、現在の日付および時刻を返します。
\end{methoddesc}

\begin{methoddesc}{address_string}{}
ログ記録向けに書式化された、クライアントのアドレスを返します。
このときクライアントの IP アドレスに対する名前解決を行います。
\end{methoddesc}


\begin{seealso}
  \seemodule{CGIHTTPServer}{CGI スクリプトをサポートするように拡張されたリクエストハンドラ。}

  \seemodule{SimpleHTTPServer}{ドキュメントルートの下にあるファイルに対する要求への応答のみに制限した基本リクエストハンドラ。}
\end{seealso}
