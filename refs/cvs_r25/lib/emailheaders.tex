\declaremodule{standard}{email.header}
\modulesynopsis{非ASCII形式のヘッダを表現する}

\rfc{2822} は電子メールメッセージの形式を規定する基本規格です。
これはほとんどの電子メールが \ASCII{} 文字のみで構成されていたころ普及した
\rfc{822} 標準から発展したものです。\rfc{2822} は電子メールが
すべて 7-bit \ASCII{} 文字のみから構成されていると仮定して作られた仕様です。

もちろん、電子メールが世界的に普及するにつれ、この仕様は国際化されてきました。
今では電子メールに言語依存の文字セットを使うことができます。
基本規格では、まだ電子メールメッセージを 7-bit \ASCII{} 文字のみを
使って転送するよう要求していますので、多くの RFC でどうやって
非\ASCII{} の電子メールを \rfc{2822}準拠な形式にエンコードするかが
記述されています。これらの RFC は以下のものを含みます:
\rfc{2045}、 \rfc{2046}、 \rfc{2047}、 および \rfc{2231}。
\module{email} パッケージは、
\module{email.header} および \module{email.charset} モジュールでこれらの規格を
サポートしています。

ご自分の電子メールヘッダ、たとえば \mailheader{Subject} や
\mailheader{To} などのフィールドに非\ASCII{}文字を入れたい場合、
\class{Header} クラスを使う必要があります。\class{Message} オブジェクトの
該当フィールドに文字列ではなく、\class{Header} インスタンスを
使うのです。 \class{Header}クラスは\module{email.header}モジュールから
インポートしてください。 たとえば:

\begin{verbatim}
>>> from email.message import Message
>>> from email.header import Header
>>> msg = Message()
>>> h = Header('p\xf6stal', 'iso-8859-1')
>>> msg['Subject'] = h
>>> print msg.as_string()
Subject: =?iso-8859-1?q?p=F6stal?=


\end{verbatim}

\mailheader{Subject} フィールドに非\ASCII{}文字をふくめていることに
注目してください。ここでは、含めたいバイト列がエンコードされている
文字セットを指定して \class{Header} インスタンスを作成することによって
実現しています。のちにこの \class{Message} インスタンスから
フラットなテキストを生成するさいに、この \mailheader{Subject} フィールドは
\rfc{2047} 準拠の適切な形式にエンコードされます。MIME 機能のついている
メーラなら、このヘッダに埋めこまれた ISO-8859-1 文字をただしく表示するでしょう。

\versionadded{2.2.2}

以下は \class{Header} クラスの説明です:

\begin{classdesc}{Header}{\optional{s\optional{, charset\optional{,
    maxlinelen\optional{, header_name\optional{, continuation_ws\optional{,
    errors}}}}}}}
別の文字セットの文字列をふくむ MIME準拠なヘッダを作成します。

オプション引数 \var{s} はヘッダの値の初期値です。
これが \code{None} の場合 (デフォルト)、ヘッダの初期値は設定されません。
この値はあとから \method{append()} メソッドを呼びだすことによって
追加することができます。\var{s} はバイト文字列か、あるいは Unicode 文字列でもかまいません。
この意味については \method{append()} の項を参照してください。

オプション引数 \var{charset} には 2つの目的があります。
ひとつは \method{append()} メソッドにおける \var{charset} 引数と
同じものです。もうひとつの目的は、これ以降 \var{charset} 引数を
省略した \method{append()} メソッド呼び出しすべてにおける、
デフォルト文字セットを決定するものです。コンストラクタに
\var{charset} が与えられない場合 (デフォルト)、初期値の \var{s} および
以後の \method{append()} 呼び出しにおける文字セットとして
\code{us-ascii} が使われます。

行の最大長は \var{maxlinelen} によって明示的に指定できます。
最初の行を (\mailheader{Subject} などの \var{s} に含まれない
フィールドヘッダの責任をとるため) 短く切りとる場合、
\var{header_name} にそのフィールド名を指定してください。
\var{maxlinelen} のデフォルト値は 76 であり、\var{header_name} の
デフォルト値は \code{None} です。これはその最初の行を
長い、切りとられたヘッダとして扱わないことを意味します。

オプション引数 \var{continuation_ws} は \rfc{2822}準拠の
折り返し用余白文字で、ふつうこれは空白か、ハードウェアタブ文字 (hard tab) である
必要があります。ここで指定された文字は複数にわたる行の行頭に挿入されます。

オプション引数 \var{errors} は、\method{append()} メソッドにそのまま渡されます。
\end{classdesc}

\begin{methoddesc}[Header]{append}{s\optional{, charset\optional{, errors}}}
この MIME ヘッダに文字列 \var{s} を追加します。

オプション引数 \var{charset} がもし与えられた場合、これは
\class{Charset} インスタンス (\refmodule{email.charset} を参照) か、
あるいは文字セットの名前でなければなりません。この場合は \class{Charset} 
インスタンスに変換されます。この値が \code{None} の場合 (デフォルト)、
コンストラクタで与えられた \var{charset} が使われます。

\var{s} はバイト文字列か、Unicode 文字列です。
こればバイト文字列 (\code{isinstance(s, str)} が真) の場合、
\var{charset} はその文字列のエンコーディングであり、
これが与えられた文字セットでうまくデコードできないときは
\exception{UnicodeError} が発生します。

いっぽう \var{s} が Unicode 文字列の場合、\var{charset} は
その文字列の文字セットを決定するためのヒントとして使われます。
この場合、\rfc{2822}準拠のヘッダは \rfc{2047} の規則をもちいて作成され、
Unicode 文字列は以下の文字セットを (この優先順位で) 適用してエンコードされます:
\code{us-ascii}、 \var{charset} で与えられたヒント、それもなければ \code{utf-8}。
最初の文字セットは \exception{UnicodeError} をなるべくふせぐために使われます。

オプション引数 \var{errors} は \function{unicode()} 又は \function{ustr.encode()}
の呼び出し時に使用し、デフォルト値は ``strict''です。
\end{methoddesc}

\begin{methoddesc}[Header]{encode}{\optional{splitchars}}
メッセージヘッダを RFC に沿ったやり方でエンコードします。
おそらく長い行は折り返され、非\ASCII{}部分は base64 または
quoted-printable エンコーディングで包含されるでしょう。
オプション引数 \var{splitchars} には長いASCII行を分割する
文字の文字列を指定し、 \rfc{2822} の\emph{highest level syntactic breaks}の
大まかなサポートの為に使用します。この引数は \rfc{2047} でエンコード
された行には影響しません。
\end{methoddesc}

\class{Header} クラスは、標準の演算子や組み込み関数を
サポートするためのメソッドもいくつか提供しています。

\begin{methoddesc}[Header]{__str__}{}
\method{Header.encode()} と同じです。
\code{str(aHeader)} などとすると有用でしょう。
\end{methoddesc}

\begin{methoddesc}[Header]{__unicode__}{}
組み込みの \function{unicode()} 関数の補助です。
ヘッダを Unicode 文字列として返します。
\end{methoddesc}

\begin{methoddesc}[Header]{__eq__}{other}
このメソッドは、ふたつの \class{Header} インスタンスどうしが等しいかどうか
判定するのに使えます。
\end{methoddesc}

\begin{methoddesc}[Header]{__ne__}{other}
このメソッドは、ふたつの \class{Header} インスタンスどうしが異なっているかどうかを
判定するのに使えます。
\end{methoddesc}

さらに、\module{email.header} モジュールは以下のような
便宜的な関数も提供しています。

\begin{funcdesc}{decode_header}{header}
文字セットを変換することなしに、メッセージのヘッダをデコードします。
ヘッダの値は \var{header} に渡します。

この関数はヘッダのそれぞれのデコードされた部分ごとに、
\code{(decoded_string, charset)} という形式の 2要素タプルからなる
リストを返します。\var{charset} はヘッダのエンコードされていない部分に
対しては \code{None} を、それ以外の場合はエンコードされた文字列が
指定している文字セットの名前を小文字からなる文字列で返します。

以下はこの使用例です:

\begin{verbatim}
>>> from email.header import decode_header
>>> decode_header('=?iso-8859-1?q?p=F6stal?=')
[('p\xf6stal', 'iso-8859-1')]
\end{verbatim}
\end{funcdesc}

\begin{funcdesc}{make_header}{decoded_seq\optional{, maxlinelen\optional{,
    header_name\optional{, continuation_ws}}}}
\function{decode_header()} によって返される 2要素タプルのリストから
\class{Header} インスタンスを作成します。

\function{decode_header()} はヘッダの値をとってきて、
\code{(decoded_string, charset)} という形式の 2要素タプルからなる
リストを返します。ここで \var{decoded_string} はデコードされた文字列、
\var{charset} はその文字セットです。

この関数はこれらのリストの項目から、\class{Header} インスタンスを返します。
オプション引数 \var{maxlinelen}、\var{header_name} および
\var{continuation_ws} は \class{Header} コンストラクタに与えるものと同じです。
\end{funcdesc}
