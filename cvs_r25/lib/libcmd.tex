\section{\module{cmd} ---
         行指向のコマンドインタープリタのサポート}

\declaremodule{standard}{cmd}
\sectionauthor{Eric S. Raymond}{esr@snark.thyrsus.com}
\modulesynopsis{行指向のコマンドインタープリタを構築}


\class{Cmd}クラスでは、行指向のコマンドインタープリタを書くための簡単なフレームワークを提供します。テスト用の仕掛けや管理ツール、そして、後により洗練されたインターフェイスでラップするプロトタイプとして、こうしたインタープリタはよく役に立ちます。

\begin{classdesc}{Cmd}{\optional{completekey\optional{,
                       stdin\optional{, stdout}}}}
\class{Cmd}インスタンス、あるいはサブクラスのインスタンスは、行指向のインタープリタ・フレームワークです。\class{Cmd}自身をインスタンス化することはありません。むしろ、\class{Cmd}のメソッドを継承したり、 アクションメソッドをカプセル化するために、あなたが自分で定義するインタープリタクラスのスーパークラスとしての便利です。

オプション引数 \var{completekey} は、補完キーの\refmodule{readline}名です。
デフォルトは\kbd{Tab}です。\var{completekey}が\constant{None}でなく、
\module{readline}が利用できるならば、コマンド補完は自動的に行われます。

オプション引数 \var{stdin}と\var{stdout}には、Cmd またはそのサブクラスの
インスタンスが入出力に使用するファイルオブジェクトを指定します。
省略時には\var{sys.stdin} と \var{sys.stdout} が使用されます。

\versionchanged[引数 \var{stdin} と \var{stdout} を追加]{2.3}
\end{classdesc}

\subsection{Cmdオブジェクト}
\label{Cmd-objects}

\class{Cmd}インスタンスは、次のメソッドを持ちます:

\begin{methoddesc}{cmdloop}{\optional{intro}}
プロンプトを繰り返し出し、入力を受け取り、受け取った入力から取り去った先頭の語を解析し、その行の残りを引数としてアクションメソッドへディスパッチします。

オプションの引数は、最初のプロンプトの前に表示されるバナーあるいは紹介用の文字列です(これはクラスメンバ\member{intro}をオーバーライドします)。

\refmodule{readline}モジュールがロードされているなら、入力は自動的に\program{bash}のような履歴リスト編集機能を受け継ぎます(例えば、\kbd{Control-P}は直前のコマンドへのスクロールバック、\kbd{Control-N}は次のものへ進む、\kbd{Control-F}はカーソルを右へ非破壊的に進める、\kbd{Control-B}はカーソルを非破壊的に左へ移動させる等)。

入力のファイル終端は、文字列\code{'EOF'}として渡されます。

メソッド\method{do_foo()}を持っている場合に限って、インタープリタのインスタンスはコマンド名\samp{foo}を認識します。特別な場合として、文字\character{?}で始まる行はメソッド\method{do_help()}へディスパッチします。他の特別な場合として、文字\character{!}で始まる行はメソッド\method{do_shell()}へディスパッチします (このようなメソッドが定義されている場合)。

このメソッドは \method{postcmd()} メソッドが真を返したときに return します。
\method{postcmd()} に対する \var{stop} 引数は、このコマンドが対応する
\method{do_*()} メソッドからの返り値です。

補完が有効になっているなら、コマンドの補完が自動的に行われます。また、コマンド引数の補完は、引数\var{text}、\var{line}、\var{begidx}、および\var{endidx}と共に\method{complete_foo()}を呼び出すことによって行われます。\var{text}は、我々がマッチしようとしている文字列の先頭の語です。返されるマッチは全てそれで始まっていなければなりません。\var{line}は始めの空白を除いた現在の入力行です。\var{begidx}と\var{endidx}は先頭のテキストの始まりと終わりのインデックスで、引数の位置に依存した異なる補完を提供するのに使えます。

\class{Cmd}のすべてのサブクラスは、定義済みの\method{do_help()}を継承します。このメソッドは、(引数\code{'bar'}と共に呼ばれたとすると)対応するメソッド\method{help_bar()}を呼び出します。引数がなければ、\method{do_help()}は、すべての利用可能なヘルプ見出し(すなわち、対応する\method{help_*()}メソッドを持つすべてのコマンド)をリストアップします。また、文書化されていないコマンドでも、すべてリストアップします。
\end{methoddesc}

\begin{methoddesc}{onecmd}{str}
プロンプトに答えてタイプしたかのように引数を解釈実行します。これをオーバーライドすることがあるかもしれませんが、通常は必要ないでしょう。便利な実行フックについては、\method{precmd()}と\method{postcmd()}メソッドを参照してください。戻り値は、インタープリタによるコマンドの解釈実行をやめるかどうかを示すフラグです。
コマンド \var{str} に対応する \method{do_*()} メソッドがある場合、
そのメソッドの返り値が返されます。そうでない場合は \method{default()} メソッドからの
返り値が返されます。
\end{methoddesc}

\begin{methoddesc}{emptyline}{}
プロンプトに空行が入力されたときに呼び出されるメソッド。このメソッドがオーバーライドされていないなら、最後に入力された空行でないコマンドが繰り返されます。
\end{methoddesc}

\begin{methoddesc}{default}{line}
コマンドの先頭の語が認識されないときに、入力行に対して呼び出されます。このメソッドがオーバーライドされていないなら、エラーメッセージを表示して戻ります。
\end{methoddesc}

\begin{methoddesc}{completedefault}{text, line, begidx, endidx}
利用可能なコマンド固有の\method{complete_*()}が存在しないときに、入力行を補完するために呼び出されるメソッド。デフォルトでは、空行を返します。
\end{methoddesc}

\begin{methoddesc}{precmd}{line}
コマンド行\var{line}が解釈実行される直前、しかし入力プロンプトが作られ表示された後に実行されるフックメソッド。このメソッドは\class{Cmd}内のスタブであって、サブクラスでオーバーライドされるために存在します。戻り値は\method{onecmd()}メソッドが実行するコマンドとして使われます。\method{precmd()}の実装では、コマンドを書き換えるかもしれないし、あるいは単に変更していない\var{line}を返すかもしれません。
\end{methoddesc}

\begin{methoddesc}{postcmd}{stop, line}
コマンドディスパッチが終わった直後に実行されるフックメソッド。このメソッドは\class{Cmd}内のスタブで、サブクラスでオーバーライドされるために存在します。\var{line}は実行されたコマンド行で、\var{stop}は\method{postcmd()}の呼び出しの後に実行を停止するかどうかを示すフラグです。これは\method{onecmd()}メソッドの戻り値です。このメソッドの戻り値は、\var{stop}に対応する内部フラグの新しい値として使われます。偽を返すと、実行を続けます。
\end{methoddesc}

\begin{methoddesc}{preloop}{}
\method{cmdloop()}が呼び出されたときに一度だけ実行されるフックメソッド。このメソッドは\class{Cmd}内のスタブであって、サブクラスでオーバーライドされるために存在します。
\end{methoddesc}

\begin{methoddesc}{postloop}{}
\method{cmdloop()}が戻る直前に一度だけ実行されるフックメソッド。このメソッドは\class{Cmd}内のスタブであって、サブクラスでオーバーライドされるために存在します。
\end{methoddesc}

\class{Cmd}のサブクラスのインスタンスは、公開されたインスタンス変数をいくつか持っています:

\begin{memberdesc}{prompt}
入力を求めるために表示されるプロンプト。
\end{memberdesc}

\begin{memberdesc}{identchars}
コマンドの先頭の語として受け入れられる文字の文字列。
\end{memberdesc}

\begin{memberdesc}{lastcmd}
最後の空でないコマンドプリフィックス。
\end{memberdesc}

\begin{memberdesc}{intro}
紹介またはバナーとして表示される文字列。\method{cmdloop()}メソッドに引数を与えるために、オーバーライドされるかもしれません。
\end{memberdesc}

\begin{memberdesc}{doc_header}
ヘルプの出力に文書化されたコマンドの部分がある場合に表示するヘッダ。
\end{memberdesc}

\begin{memberdesc}{misc_header}
ヘルプの出力にその他のヘルプ見出しがある(すなわち、\method{do_*()}メソッドに対応していない\method{help_*()}メソッドが存在する)場合に表示するヘッダ。
\end{memberdesc}

\begin{memberdesc}{undoc_header}
ヘルプの出力に文書化されていないコマンドの部分がある(すなわち、対応する\method{help_*()}メソッドを持たない\method{do_*()}メソッドが存在する)場合に表示するヘッダ。
\end{memberdesc}

\begin{memberdesc}{ruler}
ヘルプメッセージのヘッダの下に、区切り行を表示するために使われる文字。空のときは、ルーラ行が表示されません。デフォルトでは、\character{=}です。
\end{memberdesc}

\begin{memberdesc}{use_rawinput}
フラグ、デフォルトでは真。真ならば、\method{cmdloop()}はプロンプトを表示して次のコマンド読み込むために\function{raw_input()}を使います。偽ならば、\method{sys.stdout.write()}と\method{sys.stdin.readline()}が使われます。
(これが意味するのは、\refmodule{readline}を import することによって、
それをサポートするシステム上では、インタープリタが自動的に \program{Emacs}形式の行編集と
コマンド履歴のキーストロークをサポートするということです。)
\end{memberdesc}
